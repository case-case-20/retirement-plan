<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Insurance Needs Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .form-section {
            padding: 40px;
            border-right: 1px solid #eee;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .results-section {
            padding: 40px;
            background: #f8f9fa;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .insurance-purpose {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .purpose-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .purpose-tab {
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            text-align: center;
            min-width: 140px;
        }
        
        .purpose-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .purpose-content {
            display: none;
        }
        
        .purpose-content.active {
            display: block;
        }
        
        .asset-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .save-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e1e8ed;
        }

        .save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #e74c3c;
        }
        
        .results-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .insurance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .breakdown {
            display: grid;
            gap: 10px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            border-top: 2px solid #2c3e50;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .pdf-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #0c5460;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #eee;
                max-height: none;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .purpose-tabs {
                flex-direction: column;
            }
            
            .back-btn {
                position: static;
                margin-bottom: 20px;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="dashboard.html" class="back-btn">
                ‚Üê Back to Dashboard
            </a>
            <h1>Life Insurance Needs Calculator</h1>
            <p>Determine optimal coverage based on your client's specific needs and goals</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <h2 class="section-title">Client Information</h2>
                
                <div class="input-group">
                    <label for="clientName">Client Full Name</label>
                    <input type="text" id="clientName" placeholder="Enter client's full name" required>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="clientAge">Age</label>
                        <input type="number" id="clientAge" value="35" min="18" max="80">
                    </div>
                    
                    <div class="input-group">
                        <label for="annualIncome">Annual Income ($)</label>
                        <input type="number" id="annualIncome" value="75000" min="0" step="1000">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="maritalStatus">Marital Status</label>
                        <select id="maritalStatus">
                            <option value="single">Single</option>
                            <option value="married" selected>Married</option>
                            <option value="divorced">Divorced</option>
                            <option value="widowed">Widowed</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="numChildren">Number of Dependent Children</label>
                        <input type="number" id="numChildren" value="2" min="0" max="10">
                    </div>
                </div>
                
                <h3 class="section-title" style="margin-top: 30px; font-size: 1.3rem;">Insurance Purpose</h3>
                
                <div class="insurance-purpose">
                    <div class="purpose-tabs">
                        <div class="purpose-tab active" onclick="switchPurpose('mortgage')">Mortgage Protection</div>
                        <div class="purpose-tab" onclick="switchPurpose('income')">Income Replacement</div>
                        <div class="purpose-tab" onclick="switchPurpose('estate')">Estate Planning</div>
                    </div>

                    <!-- Mortgage Protection -->
                    <div id="mortgageContent" class="purpose-content active">
                        <div class="info-box">
                            <strong>Mortgage Protection:</strong> Ensure the family home is paid off if something happens to the breadwinner.
                        </div>
                        <div class="input-group">
                            <label for="mortgageBalance">Outstanding Mortgage Balance ($)</label>
                            <input type="number" id="mortgageBalance" value="450000" min="0" step="1000">
                        </div>
                        <div class="input-group">
                            <label for="propertyTaxes">Annual Property Taxes ($)</label>
                            <input type="number" id="propertyTaxes" value="5000" min="0" step="100">
                        </div>
                        <div class="input-group">
                            <label for="homeInsurance">Annual Home Insurance ($)</label>
                            <input type="number" id="homeInsurance" value="2000" min="0" step="100">
                        </div>
                    </div>

                    <!-- Income Replacement -->
                    <div id="incomeContent" class="purpose-content">
                        <div class="info-box">
                            <strong>Income Replacement:</strong> Replace income to maintain family's standard of living and support dependents.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="incomeReplacement">Income Replacement (%)</label>
                                <select id="incomeReplacement">
                                    <option value="60">60%</option>
                                    <option value="70" selected>70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="incomeYears">Years of Replacement</label>
                                <input type="number" id="incomeYears" value="20" min="5" max="50">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="childEducationCost">Children's Education Fund ($)</label>
                            <input type="number" id="childEducationCost" value="100000" min="0" step="5000">
                        </div>
                        <div class="input-group">
                            <label for="emergencyFund">Emergency Fund (months of expenses)</label>
                            <input type="number" id="emergencyFund" value="6" min="0" max="24">
                        </div>
                        <div class="input-group">
                            <label for="monthlyExpenses">Monthly Living Expenses ($)</label>
                            <input type="number" id="monthlyExpenses" value="4500" min="0" step="100">
                        </div>
                    </div>

                    <!-- Estate Planning -->
                    <div id="estateContent" class="purpose-content">
                        <div class="info-box">
                            <strong>Estate Planning:</strong> Comprehensive coverage considering all assets and tax implications.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="estateRRSP">RRSP Balance ($)</label>
                                <input type="number" id="estateRRSP" value="200000" min="0" step="1000">
                            </div>
                            <div class="input-group">
                                <label for="estateTFSA">TFSA Balance ($)</label>
                                <input type="number" id="estateTFSA" value="75000" min="0" step="1000">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="estateNonReg">Non-Registered Investments ($)</label>
                                <input type="number" id="estateNonReg" value="150000" min="0" step="1000">
                            </div>
                            <div class="input-group">
                                <label for="estateHomeValue">Home Value ($)</label>
                                <input type="number" id="estateHomeValue" value="650000" min="0" step="5000">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="estateOtherAssets">Other Assets ($)</label>
                                <input type="number" id="estateOtherAssets" value="50000" min="0" step="1000">
                            </div>
                            <div class="input-group">
                                <label for="estateTaxRate">Estimated Tax Rate on Death (%)</label>
                                <input type="number" id="estateTaxRate" value="25" min="0" max="50" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="estateGoal">Estate Goal ($)</label>
                            <input type="number" id="estateGoal" value="500000" min="0" step="5000">
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title" style="margin-top: 30px; font-size: 1.3rem;">Common Information</h3>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="otherDebts">Other Debts ($)</label>
                        <input type="number" id="otherDebts" value="25000" min="0" step="1000">
                    </div>
                    
                    <div class="input-group">
                        <label for="liquidAssets">Liquid Assets ($)</label>
                        <input type="number" id="liquidAssets" value="50000" min="0" step="1000">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="existingLifeInsurance">Existing Life Insurance ($)</label>
                        <input type="number" id="existingLifeInsurance" value="0" min="0" step="1000">
                    </div>
                    
                    <div class="input-group">
                        <label for="finalExpenses">Final Expenses ($)</label>
                        <input type="number" id="finalExpenses" value="15000" min="0" step="1000">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateInsurance()">
                    Calculate Insurance Needs
                </button>

                <div class="save-section" id="saveSection" style="display: none;">
                    <div class="alert alert-success" id="calculationSuccess" style="display: none;">
                        Calculation complete! You can now save this insurance analysis.
                    </div>
                    <button type="button" class="save-btn" id="savePlan" onclick="saveCalculation()">Save Insurance Analysis</button>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Insurance Analysis Results</h2>
                
                <div id="results" class="hidden">
                    <div class="results-card">
                        <h3>Recommended Life Insurance Coverage</h3>
                        <div class="insurance-amount" id="totalCoverage">$0</div>
                        <p style="color: #7f8c8d;" id="purposeUsed">Purpose: Mortgage Protection</p>
                    </div>
                    
                    <div class="results-card">
                        <h3>Coverage Breakdown</h3>
                        <div class="breakdown" id="breakdown">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                    
                    <div class="results-card">
                        <h3>Analysis Summary</h3>
                        <div id="summary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                    
                    <button class="pdf-btn" onclick="generatePDF()" id="pdfBtn">
                        Generate Insurance Report
                    </button>
                </div>
                
                <div id="placeholder" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìã</div>
                    <h3 style="margin-bottom: 10px;">Ready to analyze insurance needs?</h3>
                    <p>Fill out the client information and select the insurance purpose to determine optimal coverage.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://cilghirivogsoxjgstui.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpbGdoaXJpdm9nc294amdzdHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNzM2MTAsImV4cCI6MjA3Mjg0OTYxMH0._6D9W6a5zrQ7mTtqdmIpp-UWlzEG2jQOELUefnBqySo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let currentUser = null;
        let calculationResults = null;
        let currentPurpose = 'mortgage';
        let isEditing = false;
        let editingId = null;
        
        // Initialize if authenticated
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            
            // Check for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            if (editId) {
                await loadPlanForEditing(editId);
            }
        });
        
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                    return false;
                }
                currentUser = session.user;
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'index.html';
                return false;
            }
        }
        
        // Function to switch insurance purpose tabs
        function switchPurpose(purpose) {
            // Update active tab
            document.querySelectorAll('.purpose-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchPurpose('${purpose}')"]`).classList.add('active');
            
            // Show appropriate content
            document.querySelectorAll('.purpose-content').forEach(content => content.classList.remove('active'));
            document.getElementById(purpose + 'Content').classList.add('active');
            
            currentPurpose = purpose;
        }
        
        function calculateInsurance() {
            const clientName = document.getElementById('clientName').value.trim();
            
            if (!clientName) {
                alert('Please enter the client name before calculating.');
                document.getElementById('clientName').focus();
                return;
            }
            
            // Get basic client information
            const clientAge = parseInt(document.getElementById('clientAge').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const numChildren = parseInt(document.getElementById('numChildren').value) || 0;
            
            // Get common financial information
            const otherDebts = parseFloat(document.getElementById('otherDebts').value) || 0;
            const liquidAssets = parseFloat(document.getElementById('liquidAssets').value) || 0;
            const existingLifeInsurance = parseFloat(document.getElementById('existingLifeInsurance').value) || 0;
            const finalExpenses = parseFloat(document.getElementById('finalExpenses').value) || 0;
            
            let totalCoverage = 0;
            let breakdown = {};
            let purposeDescription = '';
            
            // Calculate based on selected purpose
            switch (currentPurpose) {
                case 'mortgage':
                    const result = calculateMortgageProtection();
                    totalCoverage = result.total;
                    breakdown = result.breakdown;
                    purposeDescription = 'Mortgage Protection';
                    break;
                    
                case 'income':
                    const incomeResult = calculateIncomeReplacement(annualIncome);
                    totalCoverage = incomeResult.total;
                    breakdown = incomeResult.breakdown;
                    purposeDescription = 'Income Replacement';
                    break;
                    
                case 'estate':
                    const estateResult = calculateEstatePlanning();
                    totalCoverage = estateResult.total;
                    breakdown = estateResult.breakdown;
                    purposeDescription = 'Estate Planning';
                    break;
            }
            
            // Add common expenses
            breakdown['Final Expenses'] = finalExpenses;
            breakdown['Other Debts'] = otherDebts;
            totalCoverage += finalExpenses + otherDebts;
            
            // Subtract existing coverage and liquid assets
            const netCoverageNeeded = Math.max(0, totalCoverage - existingLifeInsurance - liquidAssets);
            
            // Store results globally
            calculationResults = {
                inputs: {
                    clientName,
                    clientAge,
                    annualIncome,
                    maritalStatus,
                    numChildren,
                    otherDebts,
                    liquidAssets,
                    existingLifeInsurance,
                    finalExpenses,
                    purpose: currentPurpose,
                    purposeDescription,
                    ...getPurposeSpecificInputs()
                },
                calculations: {
                    totalCoverage,
                    netCoverageNeeded,
                    breakdown,
                    existingLifeInsurance,
                    liquidAssets,
                    purpose: purposeDescription
                }
            };
            
            displayResults(calculationResults.calculations);
        }
        
        function calculateMortgageProtection() {
            const mortgageBalance = parseFloat(document.getElementById('mortgageBalance').value) || 0;
            const propertyTaxes = parseFloat(document.getElementById('propertyTaxes').value) || 0;
            const homeInsurance = parseFloat(document.getElementById('homeInsurance').value) || 0;
            
            // Calculate 5 years of property costs
            const propertyCosts = (propertyTaxes + homeInsurance) * 5;
            
            const breakdown = {
                'Mortgage Balance': mortgageBalance,
                'Property Costs (5 years)': propertyCosts
            };
            
            const total = mortgageBalance + propertyCosts;
            return { total, breakdown };
        }
        
        function calculateIncomeReplacement(income) {
            const replacementPercentage = parseInt(document.getElementById('incomeReplacement').value) / 100;
            const years = parseInt(document.getElementById('incomeYears').value);
            const childEducationCost = parseFloat(document.getElementById('childEducationCost').value) || 0;
            const emergencyFundMonths = parseInt(document.getElementById('emergencyFund').value) || 6;
            const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
            
            const annualReplacement = income * replacementPercentage;
            const totalIncomeReplacement = annualReplacement * years;
            const emergencyFund = monthlyExpenses * emergencyFundMonths;
            
            const breakdown = {
                'Income Replacement': totalIncomeReplacement,
                'Emergency Fund': emergencyFund,
                'Education Fund': childEducationCost
            };
            
            const total = totalIncomeReplacement + emergencyFund + childEducationCost;
            return { total, breakdown };
        }
        
        function calculateEstatePlanning() {
            const rrspBalance = parseFloat(document.getElementById('estateRRSP').value) || 0;
            const tfsaBalance = parseFloat(document.getElementById('estateTFSA').value) || 0;
            const nonRegBalance = parseFloat(document.getElementById('estateNonReg').value) || 0;
            const homeValue = parseFloat(document.getElementById('estateHomeValue').value) || 0;
            const otherAssets = parseFloat(document.getElementById('estateOtherAssets').value) || 0;
            const taxRate = parseFloat(document.getElementById('estateTaxRate').value) / 100 || 0.25;
            const estateGoal = parseFloat(document.getElementById('estateGoal').value) || 0;
            
            // Calculate tax liability (RRSP and non-reg investments are taxable on death)
            const taxableAssets = rrspBalance + (nonRegBalance * 0.5); // Assume 50% capital gains on non-reg
            const taxLiability = taxableAssets * taxRate;
            
            // Calculate estate shortfall
            const totalAssets = rrspBalance + tfsaBalance + nonRegBalance + homeValue + otherAssets;
            const netEstate = totalAssets - taxLiability;
            const estateShortfall = Math.max(0, estateGoal - netEstate);
            
            const breakdown = {
                'Estate Tax Liability': taxLiability,
                'Estate Shortfall': estateShortfall
            };
            
            const total = taxLiability + estateShortfall;
            return { total, breakdown };
        }
        
        function getPurposeSpecificInputs() {
            const inputs = {};
            
            switch (currentPurpose) {
                case 'mortgage':
                    inputs.mortgageBalance = parseFloat(document.getElementById('mortgageBalance').value) || 0;
                    inputs.propertyTaxes = parseFloat(document.getElementById('propertyTaxes').value) || 0;
                    inputs.homeInsurance = parseFloat(document.getElementById('homeInsurance').value) || 0;
                    break;
                    
                case 'income':
                    inputs.incomeReplacement = parseInt(document.getElementById('incomeReplacement').value);
                    inputs.incomeYears = parseInt(document.getElementById('incomeYears').value);
                    inputs.childEducationCost = parseFloat(document.getElementById('childEducationCost').value) || 0;
                    inputs.emergencyFund = parseInt(document.getElementById('emergencyFund').value);
                    inputs.monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
                    break;
                    
                case 'estate':
                    inputs.estateRRSP = parseFloat(document.getElementById('estateRRSP').value) || 0;
                    inputs.estateTFSA = parseFloat(document.getElementById('estateTFSA').value) || 0;
                    inputs.estateNonReg = parseFloat(document.getElementById('estateNonReg').value) || 0;
                    inputs.estateHomeValue = parseFloat(document.getElementById('estateHomeValue').value) || 0;
                    inputs.estateOtherAssets = parseFloat(document.getElementById('estateOtherAssets').value) || 0;
                    inputs.estateTaxRate = parseFloat(document.getElementById('estateTaxRate').value);
                    inputs.estateGoal = parseFloat(document.getElementById('estateGoal').value) || 0;
                    break;
            }
            
            return inputs;
        }
        
        function displayResults(calculations) {
            const { totalCoverage, netCoverageNeeded, breakdown, existingLifeInsurance, liquidAssets, purpose } = calculations;
            
            // Show results section
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('placeholder').style.display = 'none';
            
            // Update main coverage amount
            document.getElementById('totalCoverage').textContent = formatCurrency(netCoverageNeeded);
            document.getElementById('purposeUsed').textContent = `Purpose: ${purpose}`;
            
            // Update breakdown
            const breakdownDiv = document.getElementById('breakdown');
            breakdownDiv.innerHTML = '';
            
            // Add main breakdown items
            for (const [label, amount] of Object.entries(breakdown)) {
                if (amount > 0) {
                    const item = document.createElement('div');
                    item.className = 'breakdown-item';
                    item.innerHTML = `
                        <span>${label}</span>
                        <span>${formatCurrency(amount)}</span>
                    `;
                    breakdownDiv.appendChild(item);
                }
            }
            
            // Add subtotal
            const subtotal = document.createElement('div');
            subtotal.className = 'breakdown-item';
            subtotal.innerHTML = `
                <span>Subtotal</span>
                <span>${formatCurrency(totalCoverage)}</span>
            `;
            breakdownDiv.appendChild(subtotal);
            
            // Add deductions
            if (existingLifeInsurance > 0) {
                const existing = document.createElement('div');
                existing.className = 'breakdown-item';
                existing.innerHTML = `
                    <span>Less: Existing Life Insurance</span>
                    <span>-${formatCurrency(existingLifeInsurance)}</span>
                `;
                breakdownDiv.appendChild(existing);
            }
            
            if (liquidAssets > 0) {
                const liquid = document.createElement('div');
                liquid.className = 'breakdown-item';
                liquid.innerHTML = `
                    <span>Less: Liquid Assets</span>
                    <span>-${formatCurrency(liquidAssets)}</span>
                `;
                breakdownDiv.appendChild(liquid);
            }
            
            // Add final total
            const final = document.createElement('div');
            final.className = 'breakdown-item';
            final.innerHTML = `
                <span>Net Coverage Needed</span>
                <span>${formatCurrency(netCoverageNeeded)}</span>
            `;
            breakdownDiv.appendChild(final);
            
            // Update summary
            updateSummary(calculations);
            
            // Show save section
            document.getElementById('saveSection').style.display = 'block';
            document.getElementById('calculationSuccess').style.display = 'block';
        }
        
        function updateSummary(calculations) {
            const { netCoverageNeeded, purpose } = calculations;
            const clientName = document.getElementById('clientName').value;
            const clientAge = document.getElementById('clientAge').value;
            const annualIncome = parseFloat(document.getElementById('annualIncome').value);
            
            const summaryDiv = document.getElementById('summary');
            
            let recommendationText = '';
            if (netCoverageNeeded > 0) {
                recommendationText = `Based on the ${purpose.toLowerCase()} analysis, ${clientName} (age ${clientAge}) requires ${formatCurrency(netCoverageNeeded)} in life insurance coverage.`;
                
                if (purpose === 'Income Replacement') {
                    const years = document.getElementById('incomeYears').value;
                    recommendationText += ` This will provide ${years} years of income replacement plus educational and emergency funding.`;
                } else if (purpose === 'Mortgage Protection') {
                    recommendationText += ` This will ensure the family home is protected and property costs are covered.`;
                } else if (purpose === 'Estate Planning') {
                    recommendationText += ` This will cover estate tax liabilities and help achieve the desired estate value.`;
                }
            } else {
                recommendationText = `Based on the analysis, ${clientName} appears to have adequate existing coverage and liquid assets to meet their ${purpose.toLowerCase()} needs.`;
            }
            
            summaryDiv.innerHTML = `
                <p style="margin-bottom: 15px;">${recommendationText}</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>Key Details:</strong><br>
                    ‚Ä¢ Client: ${clientName}, Age ${clientAge}<br>
                    ‚Ä¢ Annual Income: ${formatCurrency(annualIncome)}<br>
                    ‚Ä¢ Analysis Type: ${purpose}<br>
                    ‚Ä¢ Recommended Coverage: ${formatCurrency(netCoverageNeeded)}
                </div>
            `;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        async function saveCalculation() {
            if (!calculationResults) {
                alert('Please calculate insurance needs first.');
                return;
            }
            
            try {
                const saveBtn = document.getElementById('savePlan');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                const planData = {
                    client_name: calculationResults.inputs.clientName,
                    plan_type: 'insurance',
                    inputs: calculationResults.inputs,
                    results: calculationResults.calculations,
                    user_id: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                let result;
                if (isEditing && editingId) {
                    // Update existing plan
                    result = await supabase
                        .from('financial_plans')
                        .update(planData)
                        .eq('id', editingId)
                        .select();
                } else {
                    // Create new plan
                    result = await supabase
                        .from('financial_plans')
                        .insert([planData])
                        .select();
                }
                
                if (result.error) throw result.error;
                
                alert(isEditing ? 'Insurance analysis updated successfully!' : 'Insurance analysis saved successfully!');
                
                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error saving plan:', error);
                alert('Error saving insurance analysis. Please try again.');
                
                const saveBtn = document.getElementById('savePlan');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Insurance Analysis';
            }
        }
        
        async function loadPlanForEditing(planId) {
            try {
                const { data, error } = await supabase
                    .from('financial_plans')
                    .select('*')
                    .eq('id', planId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    isEditing = true;
                    editingId = planId;
                    
                    // Populate form with existing data
                    const inputs = data.inputs;
                    
                    // Basic client info
                    document.getElementById('clientName').value = inputs.clientName || '';
                    document.getElementById('clientAge').value = inputs.clientAge || 35;
                    document.getElementById('annualIncome').value = inputs.annualIncome || 0;
                    document.getElementById('maritalStatus').value = inputs.maritalStatus || 'married';
                    document.getElementById('numChildren').value = inputs.numChildren || 0;
                    
                    // Common financial info
                    document.getElementById('otherDebts').value = inputs.otherDebts || 0;
                    document.getElementById('liquidAssets').value = inputs.liquidAssets || 0;
                    document.getElementById('existingLifeInsurance').value = inputs.existingLifeInsurance || 0;
                    document.getElementById('finalExpenses').value = inputs.finalExpenses || 0;
                    
                    // Switch to the correct purpose
                    if (inputs.purpose) {
                        switchPurpose(inputs.purpose);
                        
                        // Load purpose-specific data
                        loadPurposeSpecificData(inputs);
                    }
                    
                    // Update the page title to indicate editing
                    document.querySelector('.header h1').textContent = 'Edit Life Insurance Analysis';
                    document.getElementById('savePlan').textContent = 'Update Insurance Analysis';
                }
                
            } catch (error) {
                console.error('Error loading plan for editing:', error);
                alert('Error loading insurance analysis for editing.');
            }
        }
        
        function loadPurposeSpecificData(inputs) {
            switch (currentPurpose) {
                case 'mortgage':
                    if (inputs.mortgageBalance !== undefined) document.getElementById('mortgageBalance').value = inputs.mortgageBalance;
                    if (inputs.propertyTaxes !== undefined) document.getElementById('propertyTaxes').value = inputs.propertyTaxes;
                    if (inputs.homeInsurance !== undefined) document.getElementById('homeInsurance').value = inputs.homeInsurance;
                    break;
                    
                case 'income':
                    if (inputs.incomeReplacement !== undefined) document.getElementById('incomeReplacement').value = inputs.incomeReplacement;
                    if (inputs.incomeYears !== undefined) document.getElementById('incomeYears').value = inputs.incomeYears;
                    if (inputs.childEducationCost !== undefined) document.getElementById('childEducationCost').value = inputs.childEducationCost;
                    if (inputs.emergencyFund !== undefined) document.getElementById('emergencyFund').value = inputs.emergencyFund;
                    if (inputs.monthlyExpenses !== undefined) document.getElementById('monthlyExpenses').value = inputs.monthlyExpenses;
                    break;
                    
                case 'estate':
                    if (inputs.estateRRSP !== undefined) document.getElementById('estateRRSP').value = inputs.estateRRSP;
                    if (inputs.estateTFSA !== undefined) document.getElementById('estateTFSA').value = inputs.estateTFSA;
                    if (inputs.estateNonReg !== undefined) document.getElementById('estateNonReg').value = inputs.estateNonReg;
                    if (inputs.estateHomeValue !== undefined) document.getElementById('estateHomeValue').value = inputs.estateHomeValue;
                    if (inputs.estateOtherAssets !== undefined) document.getElementById('estateOtherAssets').value = inputs.estateOtherAssets;
                    if (inputs.estateTaxRate !== undefined) document.getElementById('estateTaxRate').value = inputs.estateTaxRate;
                    if (inputs.estateGoal !== undefined) document.getElementById('estateGoal').value = inputs.estateGoal;
                    break;
            }
        }
        
        function generatePDF() {
            if (!calculationResults) {
                alert('Please calculate insurance needs first.');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Life Insurance Needs Analysis Report', 20, 30);
                
                // Client Information
                doc.setFontSize(16);
                doc.text('Client Information', 20, 50);
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                const inputs = calculationResults.inputs;
                const results = calculationResults.calculations;
                
                let yPos = 60;
                doc.text(`Client Name: ${inputs.clientName}`, 20, yPos);
                yPos += 8;
                doc.text(`Age: ${inputs.clientAge}`, 20, yPos);
                yPos += 8;
                doc.text(`Annual Income: ${formatCurrency(inputs.annualIncome)}`, 20, yPos);
                yPos += 8;
                doc.text(`Marital Status: ${inputs.maritalStatus}`, 20, yPos);
                yPos += 8;
                doc.text(`Number of Children: ${inputs.numChildren}`, 20, yPos);
                yPos += 20;
                
                // Analysis Results
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Analysis Results', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(14);
                doc.text(`Analysis Type: ${results.purpose}`, 20, yPos);
                yPos += 10;
                doc.text(`Recommended Coverage: ${formatCurrency(results.netCoverageNeeded)}`, 20, yPos);
                yPos += 20;
                
                // Coverage Breakdown
                doc.setFontSize(14);
                doc.text('Coverage Breakdown:', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                for (const [label, amount] of Object.entries(results.breakdown)) {
                    if (amount > 0) {
                        doc.text(`${label}: ${formatCurrency(amount)}`, 25, yPos);
                        yPos += 8;
                    }
                }
                
                yPos += 5;
                doc.text(`Subtotal: ${formatCurrency(results.totalCoverage)}`, 25, yPos);
                yPos += 8;
                
                if (results.existingLifeInsurance > 0) {
                    doc.text(`Less: Existing Life Insurance: -${formatCurrency(results.existingLifeInsurance)}`, 25, yPos);
                    yPos += 8;
                }
                
                if (results.liquidAssets > 0) {
                    doc.text(`Less: Liquid Assets: -${formatCurrency(results.liquidAssets)}`, 25, yPos);
                    yPos += 8;
                }
                
                yPos += 5;
                doc.setFont(undefined, 'bold');
                doc.text(`Net Coverage Needed: ${formatCurrency(results.netCoverageNeeded)}`, 25, yPos);
                
                // Footer
                yPos += 30;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Report generated on ${new Date().toLocaleDateString()}`, 20, yPos);
                doc.text('This analysis is for informational purposes only and should not replace professional financial advice.', 20, yPos + 10);
                
                // Save the PDF
                const fileName = `Insurance_Analysis_${inputs.clientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF report. Please try again.');
            }
        }
    </script>
</body>
</html>
