<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Insurance Needs Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .form-section {
            padding: 40px;
            border-right: 1px solid #eee;
        }
        
        .results-section {
            padding: 40px;
            background: #f8f9fa;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .calculation-method {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .method-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .method-tab {
            padding: 10px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .method-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .method-content {
            display: none;
        }
        
        .method-content.active {
            display: block;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .save-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e1e8ed;
        }

        .save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #e74c3c;
        }
        
        .results-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .insurance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .breakdown {
            display: grid;
            gap: 10px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            border-top: 2px solid #2c3e50;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .pdf-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #0c5460;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .method-tabs {
                flex-direction: column;
            }
            
            .back-btn {
                position: static;
                margin-bottom: 20px;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="dashboard.html" class="back-btn">
                ‚Üê Back to Dashboard
            </a>
            <h1>Life Insurance Needs Calculator</h1>
            <p>Determine optimal life insurance coverage for your clients</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <h2 class="section-title">Client Information</h2>
                
                <div class="input-group">
                    <label for="clientName">Client Full Name</label>
                    <input type="text" id="clientName" placeholder="Enter client's full name" required>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="clientAge">Client Age</label>
                        <input type="number" id="clientAge" value="35" min="18" max="80">
                    </div>
                    
                    <div class="input-group">
                        <label for="annualIncome">Annual Income ($)</label>
                        <input type="number" id="annualIncome" value="75000" min="0" step="1000">
                    </div>
                </div>

                <div class="input-group">
                    <label for="maritalStatus">Marital Status</label>
                    <select id="maritalStatus">
                        <option value="single">Single</option>
                        <option value="married" selected>Married</option>
                        <option value="divorced">Divorced</option>
                        <option value="widowed">Widowed</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="numChildren">Number of Dependent Children</label>
                    <input type="number" id="numChildren" value="2" min="0" max="10">
                </div>
                
                <h3 class="section-title" style="margin-top: 30px; font-size: 1.3rem;">Financial Information</h3>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="mortgageBalance">Mortgage Balance ($)</label>
                        <input type="number" id="mortgageBalance" value="350000" min="0" step="1000">
                    </div>
                    
                    <div class="input-group">
                        <label for="otherDebts">Other Debts ($)</label>
                        <input type="number" id="otherDebts" value="25000" min="0" step="1000">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="liquidAssets">Liquid Assets ($)</label>
                        <input type="number" id="liquidAssets" value="50000" min="0" step="1000">
                    </div>
                    
                    <div class="input-group">
                        <label for="existingLifeInsurance">Existing Life Insurance ($)</label>
                        <input type="number" id="existingLifeInsurance" value="0" min="0" step="1000">
                    </div>
                </div>

                <div class="input-group">
                    <label for="finalExpenses">Estimated Final Expenses ($)</label>
                    <input type="number" id="finalExpenses" value="15000" min="0" step="1000">
                </div>

                <div class="calculation-method">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Calculation Method</h4>
                    
                    <div class="method-tabs">
                        <div class="method-tab active" onclick="switchMethod('needs')">Needs Analysis</div>
                        <div class="method-tab" onclick="switchMethod('income')">Income Replacement</div>
                        <div class="method-tab" onclick="switchMethod('hybrid')">Hybrid Approach</div>
                    </div>

                    <div id="needsMethod" class="method-content active">
                        <div class="info-box">
                            <strong>Needs Analysis:</strong> Calculates coverage based on specific financial obligations and goals.
                        </div>
                        <div class="input-group">
                            <label for="childEducationCost">Children's Education Fund ($)</label>
                            <input type="number" id="childEducationCost" value="100000" min="0" step="5000">
                        </div>
                        <div class="input-group">
                            <label for="emergencyFund">Emergency Fund (months of expenses)</label>
                            <input type="number" id="emergencyFund" value="6" min="0" max="24">
                        </div>
                        <div class="input-group">
                            <label for="monthlyExpenses">Monthly Living Expenses ($)</label>
                            <input type="number" id="monthlyExpenses" value="4500" min="0" step="100">
                        </div>
                    </div>

                    <div id="incomeMethod" class="method-content">
                        <div class="info-box">
                            <strong>Income Replacement:</strong> Provides income replacement for a specified number of years.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="incomeReplacement">Income Replacement (%)</label>
                                <select id="incomeReplacement">
                                    <option value="60">60%</option>
                                    <option value="70" selected>70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="incomeYears">Years of Income Replacement</label>
                                <input type="number" id="incomeYears" value="20" min="5" max="50">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="discountRate">Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="3" min="1" max="8" step="0.1">
                        </div>
                    </div>

                    <div id="hybridMethod" class="method-content">
                        <div class="info-box">
                            <strong>Hybrid Approach:</strong> Combines immediate needs with income replacement goals.
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="hybridIncomeReplacement">Income Replacement (%)</label>
                                <select id="hybridIncomeReplacement">
                                    <option value="60">60%</option>
                                    <option value="70" selected>70%</option>
                                    <option value="80">80%</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="hybridYears">Years of Income Replacement</label>
                                <input type="number" id="hybridYears" value="15" min="5" max="30">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="hybridEducationCost">Children's Education Fund ($)</label>
                                <input type="number" id="hybridEducationCost" value="75000" min="0" step="5000">
                            </div>
                            <div class="input-group">
                                <label for="hybridEmergencyFund">Emergency Fund (months)</label>
                                <input type="number" id="hybridEmergencyFund" value="6" min="0" max="12">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateInsurance()">
                    Calculate Insurance Needs
                </button>

                <div class="save-section" id="saveSection" style="display: none;">
                    <div class="alert alert-success" id="calculationSuccess" style="display: none;">
                        Calculation complete! You can now save this insurance analysis.
                    </div>
                    <button type="button" class="save-btn" id="savePlan" onclick="saveCalculation()">Save Insurance Analysis</button>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Insurance Analysis Results</h2>
                
                <div id="results" class="hidden">
                    <div class="results-card">
                        <h3>Recommended Life Insurance Coverage</h3>
                        <div class="insurance-amount" id="totalCoverage">$0</div>
                        <p style="color: #7f8c8d;" id="methodUsed">Method: Needs Analysis</p>
                    </div>
                    
                    <div class="results-card">
                        <h3>Coverage Breakdown</h3>
                        <div class="breakdown" id="breakdown">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                    
                    <div class="results-card">
                        <h3>Analysis Summary</h3>
                        <div id="summary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                    
                    <button class="pdf-btn" onclick="generatePDF()" id="pdfBtn">
                        Generate Insurance Report
                    </button>
                </div>
                
                <div id="placeholder" style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìã</div>
                    <h3 style="margin-bottom: 10px;">Ready to analyze insurance needs?</h3>
                    <p>Fill out the client information and click calculate to determine optimal coverage.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Store calculation results globally
        let calculationResults = null;
        let currentMethod = 'needs';
        
        function switchMethod(method) {
            // Update active tab
            document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchMethod('${method}')"]`).classList.add('active');
            
            // Show appropriate content
            document.querySelectorAll('.method-content').forEach(content => content.classList.remove('active'));
            document.getElementById(method + 'Method').classList.add('active');
            
            currentMethod = method;
        }
        
        function calculateInsurance() {
            const clientName = document.getElementById('clientName').value.trim();
            
            if (!clientName) {
                alert('Please enter the client name before calculating.');
                document.getElementById('clientName').focus();
                return;
            }
            
            // Get basic client information
            const clientAge = parseInt(document.getElementById('clientAge').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const numChildren = parseInt(document.getElementById('numChildren').value) || 0;
            
            // Get financial information
            const mortgageBalance = parseFloat(document.getElementById('mortgageBalance').value) || 0;
            const otherDebts = parseFloat(document.getElementById('otherDebts').value) || 0;
            const liquidAssets = parseFloat(document.getElementById('liquidAssets').value) || 0;
            const existingLifeInsurance = parseFloat(document.getElementById('existingLifeInsurance').value) || 0;
            const finalExpenses = parseFloat(document.getElementById('finalExpenses').value) || 0;
            
            let totalCoverage = 0;
            let breakdown = {};
            let methodDescription = '';
            
            switch (currentMethod) {
                case 'needs':
                    const result = calculateNeedsAnalysis(annualIncome, mortgageBalance, otherDebts, finalExpenses);
                    totalCoverage = result.total;
                    breakdown = result.breakdown;
                    methodDescription = 'Needs Analysis';
                    break;
                    
                case 'income':
                    const incomeResult = calculateIncomeReplacement(annualIncome);
                    totalCoverage = incomeResult.total;
                    breakdown = incomeResult.breakdown;
                    methodDescription = 'Income Replacement';
                    break;
                    
                case 'hybrid':
                    const hybridResult = calculateHybridApproach(annualIncome, mortgageBalance, otherDebts, finalExpenses);
                    totalCoverage = hybridResult.total;
                    breakdown = hybridResult.breakdown;
                    methodDescription = 'Hybrid Approach';
                    break;
            }
            
            // Subtract existing coverage and liquid assets
            const netCoverageNeeded = Math.max(0, totalCoverage - existingLifeInsurance - liquidAssets);
            
            // Store results globally
            calculationResults = {
                inputs: {
                    clientName,
                    clientAge,
                    annualIncome,
                    maritalStatus,
                    numChildren,
                    mortgageBalance,
                    otherDebts,
                    liquidAssets,
                    existingLifeInsurance,
                    finalExpenses,
                    method: currentMethod,
                    methodDescription
                },
                calculations: {
                    totalCoverage,
                    netCoverageNeeded,
                    breakdown,
                    existingLifeInsurance,
                    liquidAssets,
                    method: methodDescription
                }
            };
            
            displayResults(calculationResults.calculations);
        }
        
        function calculateNeedsAnalysis(income, mortgage, debts, finalExpenses) {
            const childEducationCost = parseFloat(document.getElementById('childEducationCost').value) || 0;
            const emergencyFundMonths = parseInt(document.getElementById('emergencyFund').value) || 6;
            const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
            
            const emergencyFund = monthlyExpenses * emergencyFundMonths;
            const debtPayoff = mortgage + debts;
            
            const breakdown = {
                'Emergency Fund': emergencyFund,
                'Debt Payoff': debtPayoff,
                'Education Fund': childEducationCost,
                'Final Expenses': finalExpenses
            };
            
            const total = emergencyFund + debtPayoff + childEducationCost + finalExpenses;
            
            return { total, breakdown };
        }
        
        function calculateIncomeReplacement(income) {
            const replacementPercentage = parseInt(document.getElementById('incomeReplacement').value) / 100;
            const years = parseInt(document.getElementById('incomeYears').value);
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            
            const annualReplacement = income * replacementPercentage;
            
            // Present value calculation
            const presentValue = annualReplacement * ((1 - Math.pow(1 + discountRate, -years)) / discountRate);
            
            const breakdown = {
                'Income Replacement': presentValue,
                'Final Expenses': parseFloat(document.getElementById('finalExpenses').value) || 0
            };
            
            const total = presentValue + breakdown['Final Expenses'];
            
            return { total, breakdown };
        }
        
        function calculateHybridApproach(income, mortgage, debts, finalExpenses) {
            const replacementPercentage = parseInt(document.getElementById('hybridIncomeReplacement').value) / 100;
            const years = parseInt(document.getElementById('hybridYears').value);
            const educationCost = parseFloat(document.getElementById('hybridEducationCost').value) || 0;
            const emergencyFundMonths = parseInt(document.getElementById('hybridEmergencyFund').value) || 6;
            
            // Estimate monthly expenses as 70% of income / 12
            const estimatedMonthlyExpenses = (income * 0.7) / 12;
            const emergencyFund = estimatedMonthlyExpenses * emergencyFundMonths;
            
            // Income replacement (simplified calculation)
            const annualReplacement = income * replacementPercentage;
            const incomeReplacement = annualReplacement * years * 0.7; // Rough present value adjustment
            
            const breakdown = {
                'Income Replacement': incomeReplacement,
                'Debt Payoff': mortgage + debts,
                'Education Fund': educationCost,
                'Emergency Fund': emergencyFund,
                'Final Expenses': finalExpenses
            };
            
            const total = Object.values(breakdown).reduce((sum, value) => sum + value, 0);
            
            return { total, breakdown };
        }
        
        function displayResults(data) {
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            document.getElementById('totalCoverage').textContent = 
                '$' + Math.round(data.netCoverageNeeded).toLocaleString();
            document.getElementById('methodUsed').textContent = 
                'Method: ' + data.method;
            
            const breakdown = document.getElementById('breakdown');
            breakdown.innerHTML = '';
            
            // Show breakdown items
            Object.entries(data.breakdown).forEach(([label, amount]) => {
                if (amount > 0) {
                    const div = document.createElement('div');
                    div.className = 'breakdown-item';
                    div.innerHTML = `
                        <span>${label}</span>
                        <span>$${Math.round(amount).toLocaleString()}</span>
                    `;
                    breakdown.appendChild(div);
                }
            });
            
            // Show reductions
            if (data.existingLifeInsurance > 0) {
                const div = document.createElement('div');
                div.className = 'breakdown-item';
                div.innerHTML = `
                    <span>Less: Existing Coverage</span>
                    <span>-$${Math.round(data.existingLifeInsurance).toLocaleString()}</span>
                `;
                breakdown.appendChild(div);
            }
            
            if (data.liquidAssets > 0) {
                const div = document.createElement('div');
                div.className = 'breakdown-item';
                div.innerHTML = `
                    <span>Less: Liquid Assets</span>
                    <span>-$${Math.round(data.liquidAssets).toLocaleString()}</span>
                `;
                breakdown.appendChild(div);
            }
            
            // Add total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'breakdown-item';
            totalDiv.innerHTML = `
                <span>Net Coverage Needed</span>
                <span>$${Math.round(data.netCoverageNeeded).toLocaleString()}</span>
            `;
            breakdown.appendChild(totalDiv);
            
            // Create summary
            const summary = document.getElementById('summary');
            const inputs = calculationResults.inputs;
            
            summary.innerHTML = `
                <p><strong>Client:</strong> ${inputs.clientName}</p>
                <p><strong>Age:</strong> ${inputs.clientAge}</p>
                <p><strong>Annual Income:</strong> $${inputs.annualIncome.toLocaleString()}</p>
                <p><strong>Marital Status:</strong> ${inputs.maritalStatus}</p>
                <p><strong>Children:</strong> ${inputs.numChildren}</p>
                <p><strong>Calculation Method:</strong> ${inputs.methodDescription}</p>
                <p style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>Recommendation:</strong> Based on the ${inputs.methodDescription.toLowerCase()}, your client needs approximately $${Math.round(data.netCoverageNeeded).toLocaleString()} in life insurance coverage to protect their family's financial security.
                </p>
            `;

            document.getElementById('saveSection').style.display = 'block';
            document.getElementById('calculationSuccess').style.display = 'block';
        }

        async function saveCalculation() {
            if (!calculationResults) {
                alert('Please calculate insurance needs first!');
                return;
            }
            
            const saveBtn = document.getElementById('savePlan');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                if (isEditing && editingId) {
                    // Update existing plan
                    const { error } = await supabase
                        .from('client_documents')
                        .update({
                            client_name: calculationResults.inputs.clientName,
                            inputs: calculationResults.inputs,
                            calculations: calculationResults.calculations,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', editingId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    
                } else {
                    // Add new plan
                    const { error } = await supabase
                        .from('client_documents')
                        .insert([{
                            user_id: currentUser.id,
                            document_type: 'insurance',
                            client_name: calculationResults.inputs.clientName,
                            inputs: calculationResults.inputs,
                            calculations: calculationResults.calculations
                        }]);
                    
                    if (error) throw error;
                }
                
                alert('Insurance analysis saved successfully! You can view it in your dashboard.');
                
                // Optional redirect to dashboard
                setTimeout(() => {
                    if (confirm('Would you like to return to the dashboard to view all client documents?')) {
                        window.location.href = 'dashboard.html';
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving analysis: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = isEditing ? 'Update Insurance Analysis' : 'Save Insurance Analysis';
            }
        }
        
        function generatePDF() {
            if (!calculationResults) {
                alert('Please calculate insurance needs first!');
                return;
            }
            
            const pdfBtn = document.getElementById('pdfBtn');
            pdfBtn.disabled = true;
            pdfBtn.textContent = 'Generating PDF...';
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                let yPosition = 20;
                
                function addText(text, x, y, maxWidth = pageWidth - 40) {
                    const lines = doc.splitTextToSize(text, maxWidth);
                    doc.text(lines, x, y);
                    return y + (lines.length * 6);
                }
                
                function checkNewPage(neededSpace = 20) {
                    if (yPosition + neededSpace > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                }
                
                // Title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                yPosition = addText('Life Insurance Needs Analysis Report', 20, yPosition);
                yPosition += 5;
                
                // Client name
                doc.setFontSize(16);
                doc.setFont(undefined, 'normal');
                const inputs = calculationResults.inputs;
                yPosition = addText(`Prepared for: ${inputs.clientName}`, 20, yPosition);
                yPosition += 10;
                
                // Date
                doc.setFontSize(12);
                const today = new Date().toLocaleDateString();
                yPosition = addText(`Generated on: ${today}`, 20, yPosition);
                yPosition += 15;
                
                // Client Information Section
                checkNewPage(50);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                yPosition = addText('Client Information', 20, yPosition);
                yPosition += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPosition = addText(`Name: ${inputs.clientName}`, 20, yPosition);
                yPosition = addText(`Age: ${inputs.clientAge}`, 20, yPosition);
                yPosition = addText(`Annual Income: ${inputs.annualIncome.toLocaleString()}`, 20, yPosition);
                yPosition = addText(`Marital Status: ${inputs.maritalStatus}`, 20, yPosition);
                yPosition = addText(`Number of Children: ${inputs.numChildren}`, 20, yPosition);
                yPosition += 10;
                
                // Financial Summary
                checkNewPage(50);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                yPosition = addText('Financial Summary', 20, yPosition);
                yPosition += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPosition = addText(`Mortgage Balance: ${inputs.mortgageBalance.toLocaleString()}`, 20, yPosition);
                yPosition = addText(`Other Debts: ${inputs.otherDebts.toLocaleString()}`, 20, yPosition);
                yPosition = addText(`Liquid Assets: ${inputs.liquidAssets.toLocaleString()}`, 20, yPosition);
                yPosition = addText(`Existing Life Insurance: ${inputs.existingLifeInsurance.toLocaleString()}`, 20, yPosition);
                yPosition += 10;
                
                // Results Section
                checkNewPage(60);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                yPosition = addText('INSURANCE NEEDS ANALYSIS', 20, yPosition);
                yPosition += 10;
                
                // Highlight the main result
                doc.setFillColor(252, 243, 207);
                doc.rect(15, yPosition - 5, pageWidth - 30, 25, 'F');
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                yPosition = addText(`Recommended Coverage: ${Math.round(calculationResults.calculations.netCoverageNeeded).toLocaleString()}`, 20, yPosition);
                doc.setFontSize(10);
                doc.setFont(undefined, 'italic');
                yPosition = addText(`Method Used: ${inputs.methodDescription}`, 20, yPosition + 5);
                yPosition += 15;
                
                // Coverage Breakdown
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPosition = addText('Coverage Breakdown:', 20, yPosition);
                yPosition += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const calc = calculationResults.calculations;
                
                Object.entries(calc.breakdown).forEach(([label, amount]) => {
                    if (amount > 0) {
                        yPosition = addText(`‚Ä¢ ${label}: ${Math.round(amount).toLocaleString()}`, 25, yPosition);
                    }
                });
                
                if (calc.existingLifeInsurance > 0) {
                    yPosition = addText(`‚Ä¢ Less: Existing Coverage: -${Math.round(calc.existingLifeInsurance).toLocaleString()}`, 25, yPosition);
                }
                
                if (calc.liquidAssets > 0) {
                    yPosition = addText(`‚Ä¢ Less: Liquid Assets: -${Math.round(calc.liquidAssets).toLocaleString()}`, 25, yPosition);
                }
                
                yPosition += 15;
                
                // Recommendations
                checkNewPage(50);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPosition = addText('Recommendations:', 20, yPosition);
                yPosition += 5;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const recommendations = [
                    `Based on the ${inputs.methodDescription.toLowerCase()}, we recommend ${Math.round(calc.netCoverageNeeded).toLocaleString()} in life insurance coverage.`,
                    'Consider term life insurance for temporary needs and permanent insurance for estate planning.',
                    'Review and update coverage annually or after major life events.',
                    'Consider disability insurance to protect income during your working years.',
                    'Consult with your financial advisor to integrate insurance into your overall financial plan.'
                ];
                
                recommendations.forEach(rec => {
                    yPosition = addText(`‚Ä¢ ${rec}`, 20, yPosition);
                    yPosition += 2;
                });
                
                // Footer
                checkNewPage(30);
                yPosition = pageHeight - 40;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text('This analysis is for informational purposes only and should not be considered as insurance advice.', 20, yPosition);
                doc.text('Generated by Life Insurance Needs Calculator', 20, yPosition + 8);
                doc.text(`Report Date: ${today}`, 20, yPosition + 16);
                
                // Save the PDF
                const fileName = `${inputs.clientName}_Insurance_Analysis.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('There was an error generating the PDF. Please try again.');
            } finally {
                pdfBtn.disabled = false;
                pdfBtn.textContent = 'Generate Insurance Report';
            }
        }
    </script>
</body>
</html>
